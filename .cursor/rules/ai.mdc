---
alwaysApply: true
---

# === Project Rules: AI Assistant App / Next.js / Assistant Runtime / MCP ===
Bạn là một senior fullstack engineer, chuyên sâu về:
- TypeScript
- Next.js App Router
- Vercel AI SDK ("ai")
- assistant-ui (UI + runtime)
- LLM providers: Gemini (Google AI) & OpenAI
- MCP (Model Context Protocol)

Mục tiêu tổng quát:
Xây dựng một ứng dụng chat sử dụng assistant-ui, Next.js, Assistant Runtime, LLM (Gemini/OpenAI) và MCP tools.

----------------------------------------------
# 1. Kiến trúc tổng thể
----------------------------------------------

## 1.1 Frontend
- Framework: Next.js (App Router).
- UI: assistant-ui (Thread UI + composer).
- Tất cả thư viện đều phải là mới nhất.
- Sử dụng:
  - @assistant-ui/react
  - @assistant-ui/react-markdown
  - @assistant-ui/styles
  - @assistant-ui/react-ai-sdk

## 1.2 Backend Runtime
- API endpoint chính: `/api/chat`
- Xử lý:
  - Nhận messages từ assistant-ui.
  - Chọn provider (Gemini/OpenAI).
  - Gọi Vercel AI SDK để thực thi LLM.
  - Hỗ trợ tool-calling.
  - Gọi MCP server để chạy tools nếu LLM yêu cầu.

----------------------------------------------
# 2. LLM Providers
----------------------------------------------

## 2.1 Default provider
- Default: Gemini (model `gemini-1.5-flash`).

## 2.2 OpenAI provider
- Model default: `gpt-4.1-mini` (hoặc model tương đương).

## 2.3 Chuyển provider
- Cho phép user chọn provider trên UI.
- Truyền provider xuống backend qua payload (metadata / requestTransformer).

----------------------------------------------
# 3. MCP Integration
----------------------------------------------

## 3.1 MCP server
- URL: `https://hao-mcp.vercel.app/mcp`
- Tạo client với các hàm:
  - `listTools(): Promise<ToolDef[]>`
  - `callTool(name, args): Promise<any>`

## 3.2 MCP Tools trong runtime
- Chuyển danh sách tool MCP → tool schema cho AI SDK / assistant runtime.
- Mỗi tool:
  - name
  - description
  - parameters (JSON schema)
  - execute(args) → gọi MCP server

----------------------------------------------
# 4. Source Structure Requirements
----------------------------------------------

## 4.1 File structure

# === Project Rules: AI Assistant App / Next.js / Assistant Runtime / MCP ===
Bạn là một senior fullstack engineer, chuyên sâu về:
- TypeScript
- Next.js App Router
- Vercel AI SDK ("ai")
- assistant-ui (UI + runtime)
- LLM providers: Gemini (Google AI) & OpenAI
- MCP (Model Context Protocol)

Mục tiêu tổng quát:
Xây dựng một ứng dụng chat sử dụng assistant-ui, Next.js, Assistant Runtime, LLM (Gemini/OpenAI) và MCP tools.

----------------------------------------------
# 1. Kiến trúc tổng thể
----------------------------------------------

## 1.1 Frontend
- Framework: Next.js (App Router).
- UI: assistant-ui (Thread UI + composer).
- Sử dụng:
  - @assistant-ui/react
  - @assistant-ui/react-markdown
  - @assistant-ui/styles
  - @assistant-ui/react-ai-sdk

## 1.2 Backend Runtime
- API endpoint chính: `/api/chat`
- Xử lý:
  - Nhận messages từ assistant-ui.
  - Chọn provider (Gemini/OpenAI).
  - Gọi Vercel AI SDK để thực thi LLM.
  - Hỗ trợ tool-calling.
  - Gọi MCP server để chạy tools nếu LLM yêu cầu.

----------------------------------------------
# 2. LLM Providers
----------------------------------------------

## 2.1 Default provider
- Default: Gemini (model `gemini-1.5-flash`).

## 2.2 OpenAI provider
- Model default: `gpt-4.1-mini` (hoặc model tương đương).

## 2.3 Chuyển provider
- Cho phép user chọn provider trên UI.
- Truyền provider xuống backend qua payload (metadata / requestTransformer).

----------------------------------------------
# 3. MCP Integration
----------------------------------------------

## 3.1 MCP server
- URL: `https://hao-mcp.vercel.app/mcp`
- Tạo client với các hàm:
  - `listTools(): Promise<ToolDef[]>`
  - `callTool(name, args): Promise<any>`

## 3.2 MCP Tools trong runtime
- Chuyển danh sách tool MCP → tool schema cho AI SDK / assistant runtime.
- Mỗi tool:
  - name
  - description
  - parameters (JSON schema)
  - execute(args) → gọi MCP server

----------------------------------------------
# 4. Source Structure Requirements
----------------------------------------------

## 4.1 File structure

1. src/app/
   - api/chat/route.ts
   - page.tsx

2. src/components/assistant/
   - MyAssistant.tsx

3. src/lib/assistant-runtime/
   - llm.ts
   - mcp-client.ts
   - mcp-tools.ts
   - runtime.ts

## 4.2 Vai trò các file

### llm.ts
- Hàm: `getModelConfig(provider?: "gemini" | "openai", modelName?: string)`
- Trả về object cấu hình LLM cho AI SDK.

### mcp-client.ts
- Tạo client fetch tới MCP server.
- Xuất: `mcpClient` với các hàm:
  - `listTools`
  - `callTool`

### mcp-tools.ts
- Hàm: `getMcpTools()`
- Chuyển MCP tool → tool cho runtime.

### runtime.ts
- Hàm: `createChatHandler()`
  - Nhận messages + provider
  - Gọi LLM đúng provider
  - Đăng ký MCP tools
  - Trả về streaming response cho assistant-ui.

### route.ts
- Nhận POST từ assistant-ui.
- Parse messages + provider.
- Gọi `createChatHandler`.
- Trả về streaming response.

### MyAssistant.tsx
- Thiết lập AssistantRuntimeProvider.
- Sử dụng AssistantChatTransport trỏ đến `/api/chat`.
- Render Thread + composer.
- Cho phép user chọn provider (Gemini/OpenAI).

----------------------------------------------
# 5. Env Requirements
----------------------------------------------

- `GOOGLE_GENERATIVE_AI_API_KEY`
- `OPENAI_API_KEY`
- `MCP_SERVER_URL=https://hao-mcp.vercel.app/mcp`

----------------------------------------------
# 6. Coding Rules
----------------------------------------------

- Viết code thật, không pseudo.
- Luôn TypeScript strict.
- Tách module nhỏ gọn, dễ maintain.
- Luôn ưu tiên rõ ràng hơn “magic”.
- Comment ngắn gọn khi có logic phức tạp.
- Code phải chạy được trong Next.js App Router mới.

----------------------------------------------
# 7. Khi Cursor được yêu cầu scaffold / generate code
----------------------------------------------

- Cursor phải tạo đầy đủ thư mục + file.
- Tạo skeleton chạy được ngay.
- Không tự ý thay đổi kiến trúc trừ khi cần để tương thích thư viện.
- Khi thư viện có thay đổi API, ưu tiên giải pháp ổn định nhất.

----------------------------------------------
# 8. Khi Cursor không chắc chắn về API assistant-ui
----------------------------------------------

- Chọn phiên bản mới nhất, dùng API phù hợp:
  - AssistantRuntimeProvider
  - Thread / Composer
  - useChatRuntime / AssistantChatTransport
- Nếu phải đưa ra giả định: thêm TODO comment vào code.

----------------------------------------------
# 9. Mục tiêu cuối
----------------------------------------------

- Một app chat Next.js / assistant-ui hoàn chỉnh.
- Dùng được Gemini và OpenAI qua API key.
- Tích hợp MCP tools qua server.
- Kiến trúc rõ ràng, dễ mở rộng.
